{"version":3,"sources":["../src/cm-resource-selector.js"],"names":["define","$","Ajax","Throttler","ResourceSelector","CmResourceSelector","container","searchTermFieldNode","prototype","constructor","apply","filterFunction","bind","resources","courseId","throttler","setMinChars","Object","create","initForCourse","displayResults","displaySearching","fetchAllForCourse","then","fail","displayEmptyResults","call","methodname","args","courseid","query","results","reduce","carry","section","concat","modules","map","cm","_iscm","subname","name","term","toLowerCase","filter","indexOf"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Course resource module selector.\n *\n * @package    block_xp\n * @copyright  2018 Frédéric Massart\n * @author     Frédéric Massart <fred@branchup.tech>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/ajax', 'block_xp/throttler', 'block_xp/resource-selector'], function($, Ajax, Throttler, ResourceSelector) {\n    /**\n     * Course module resource selector.\n     *\n     * @param {String|jQuery} container The container of the contents.\n     * @param {jQuery} searchTermFieldNode The input field in which the use searches.\n     */\n    function CmResourceSelector(container, searchTermFieldNode) {\n        ResourceSelector.prototype.constructor.apply(this, [container, this.filterFunction.bind(this), searchTermFieldNode]);\n        this.resources = [];\n        this.courseId = null;\n        this.throttler = new Throttler(100);\n        this.setMinChars(0);\n    }\n\n    CmResourceSelector.prototype = Object.create(ResourceSelector.prototype);\n    CmResourceSelector.prototype.constructor = CmResourceSelector;\n\n    CmResourceSelector.prototype.initForCourse = function(courseId) {\n        if (this.courseId == courseId) {\n            // The course has not changed, display the contents right away.\n            this.displayResults(this.resources);\n            return;\n        }\n\n        this.displaySearching();\n        this.courseId = courseId;\n        this.fetchAllForCourse(courseId)\n            .then(\n                function(resources) {\n                    if (this.courseId != courseId) {\n                        // We switched course in the meantime, ignore.\n                        return;\n                    }\n                    this.resources = resources;\n                    this.displayResults(this.resources);\n                }.bind(this)\n            )\n            .fail(function() {\n                this.resources = [];\n                this.displayEmptyResults();\n            }.bind(this));\n    };\n\n    CmResourceSelector.prototype.fetchAllForCourse = function(courseId) {\n        var searchargs = {\n            courseid: courseId,\n            query: '*'\n        };\n\n        var calls = [\n            {\n                methodname: 'block_xp_search_modules',\n                args: searchargs\n            }\n        ];\n\n        return Ajax.call(calls)[0].then(function(results) {\n            return results.reduce(function(carry, section) {\n                return carry.concat(\n                    section.modules.map(function(cm) {\n                        return {\n                            _iscm: true,\n                            subname: section.name,\n                            name: cm.name,\n                            cm: cm\n                        };\n                    })\n                );\n            }, []);\n        });\n    };\n\n    CmResourceSelector.prototype.filterFunction = function(term) {\n        term = (term || '').toLowerCase();\n        if (!term) {\n            return this.resources;\n        }\n        return this.resources.filter(function(cm) {\n            return cm.name.toLowerCase().indexOf(term) > -1;\n        });\n    };\n\n    return CmResourceSelector;\n});\n"],"file":"cm-resource-selector.min.js"}