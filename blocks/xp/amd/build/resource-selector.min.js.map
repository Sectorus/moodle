{"version":3,"sources":["../src/resource-selector.js"],"names":["define","$","Ajax","Throttler","ResourceSelector","container","searchFunction","searchTermFieldNode","_eventNode","searchId","searchTermNode","resultsContainer","find","emptyResultsNode","searchingResultsNode","searchResultsNode","resourceTemplateNode","hide","resourceTemplate","clone","removeClass","show","throttler","_setEventListeners","minChars","prototype","clear","empty","displayEmptyResults","displayNothing","displayResults","resources","length","_publishResults","displaySearching","getResources","term","when","onResourceSelected","callback","on","search","_performSearch","setMinChars","_onSearchTermKeyUp","e","target","value","cancel","schedule","_performSearchFactory","_onSelect","preventDefault","resource","closest","data","trigger","bind","scheduledSearchId","then","fail","forEach","node","text","name","subname","append"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Resource selector.\n *\n * @package    block_xp\n * @copyright  2018 Frédéric Massart\n * @author     Frédéric Massart <fred@branchup.tech>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/ajax', 'block_xp/throttler'], function($, Ajax, Throttler) {\n  /**\n   * Resource selector.\n   *\n   * @param {String|jQuery} container The container of the contents.\n   * @param {Function} searchFunction The search function.\n   * @param {jQuery} searchTermFieldNode The input field in which the use searches.\n   */\n  function ResourceSelector(container, searchFunction, searchTermFieldNode) {\n    this._eventNode = $('<div>');\n    this.container = $(container);\n\n    this.searchId = 0;\n    this.searchTermNode = searchTermFieldNode;\n\n    this.resultsContainer = container.find('tbody');\n    this.emptyResultsNode = container.find('.results-empty');\n    this.searchingResultsNode = container.find('.searching-results');\n    this.searchResultsNode = container.find('.search-results');\n\n    this.resourceTemplateNode = container.find('.resource-template');\n    this.resourceTemplateNode.hide();\n    this.resourceTemplate = this.resourceTemplateNode.clone();\n    this.resourceTemplate.removeClass('resource-template');\n    this.resourceTemplate.show();\n\n    this.throttler = new Throttler(300);\n    this.searchFunction = searchFunction;\n    this._setEventListeners();\n    this.minChars = 3;\n  }\n\n  ResourceSelector.prototype.clear = function() {\n    this.resultsContainer.empty();\n  };\n\n  ResourceSelector.prototype.displayEmptyResults = function() {\n    this.searchingResultsNode.hide();\n    this.emptyResultsNode.show();\n    this.searchResultsNode.hide();\n  };\n\n  ResourceSelector.prototype.displayNothing = function() {\n    this.searchingResultsNode.hide();\n    this.emptyResultsNode.hide();\n    this.searchResultsNode.hide();\n  };\n\n  ResourceSelector.prototype.displayResults = function(resources) {\n    if (!resources || !resources.length) {\n      this.displayEmptyResults();\n      return;\n    }\n\n    this._publishResults(resources);\n    this.searchingResultsNode.hide();\n    this.emptyResultsNode.hide();\n    this.searchResultsNode.show();\n  };\n\n  ResourceSelector.prototype.displaySearching = function() {\n    this.searchingResultsNode.show();\n    this.emptyResultsNode.hide();\n    this.searchResultsNode.hide();\n  };\n\n  /**\n   * Get resources.\n   *\n   * @param {String} term The term to get the results from.\n   * @return {Promise}\n   */\n  ResourceSelector.prototype.getResources = function(term) {\n    return $.when(this.searchFunction(term));\n  };\n\n  ResourceSelector.prototype.onResourceSelected = function(callback) {\n    this._eventNode.on('resource-selected', callback);\n  };\n\n  ResourceSelector.prototype.search = function(term) {\n    this.searchId += 1;\n    this._performSearch(term, this.searchId);\n  };\n\n  ResourceSelector.prototype.setMinChars = function(minChars) {\n    this.minChars = minChars;\n  };\n\n  ResourceSelector.prototype._onSearchTermKeyUp = function(e) {\n    var term = e.target.value;\n    if (typeof term !== 'string' || term.length < this.minChars) {\n      this.searchingResultsNode.hide();\n      this.throttler.cancel();\n      return;\n    }\n\n    this.displaySearching();\n    this.searchId += 1;\n    this.throttler.schedule(this._performSearchFactory(term, this.searchId));\n  };\n\n  ResourceSelector.prototype._onSelect = function(e) {\n    e.preventDefault();\n    var resource = $(e.target)\n      .closest('.resource-node')\n      .data('resource');\n    if (!resource) {\n      return;\n    }\n    this._eventNode.trigger('resource-selected', resource);\n  };\n\n  ResourceSelector.prototype._performSearchFactory = function(term, searchId) {\n    return function() {\n      this._performSearch(term, searchId);\n    }.bind(this);\n  };\n\n  ResourceSelector.prototype._performSearch = function(term, scheduledSearchId) {\n    return this.getResources(term)\n      .then(\n        function(data) {\n          if (this.searchId != scheduledSearchId) {\n            return;\n          }\n          this.displayResults(data);\n        }.bind(this)\n      )\n      .fail(\n        function() {\n          this.displayEmptyResults();\n        }.bind(this)\n      );\n  };\n\n  ResourceSelector.prototype._publishResults = function(resources) {\n    this.clear();\n\n    resources.forEach(\n      function(resource) {\n        var node = this.resourceTemplate.clone();\n        node.find('.resource-name').text(resource.name);\n        if (resource.subname) {\n          node.find('.resource-subname').text(resource.subname);\n        } else {\n          node.find('.resource-subname').hide();\n        }\n        node.data('resource', resource);\n        this.resultsContainer.append(node);\n      }.bind(this)\n    );\n  };\n\n  ResourceSelector.prototype._setEventListeners = function() {\n    this.searchTermNode.on('keyup', this._onSearchTermKeyUp.bind(this));\n    this.searchResultsNode.on('click', 'button', this._onSelect.bind(this));\n  };\n\n  return ResourceSelector;\n});\n"],"file":"resource-selector.min.js"}